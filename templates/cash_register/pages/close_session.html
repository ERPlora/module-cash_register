{% extends "ui/app_base.html" %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Close Cash Session" %}{% endblock %}

{# Section context for sidebar highlighting #}
{% block content %}
{% with current_section="cash_register" section_title=_("Cash Register") %}
{{ block.super }}
{% endwith %}
{% endblock %}

{# Tabbar is now automatically rendered by app_base.html using module_id from context #}

{% block page_content %}
{% include "cash_register/partials/close_session_content.html" %}
{% endblock %}

{% block extra_scripts %}
<script>
function closeSessionApp() {
    return {
        expectedBalance: {{ expected_balance }},
        closingBalance: {{ expected_balance }},
        notes: '',
        processing: false,
        requireClosingBalance: {{ config.require_closing_balance|yesno:"true,false" }},

        // Denomination counter
        showDenominationCounter: false,
        coins: [
            { value: 0.01, count: 0 },
            { value: 0.02, count: 0 },
            { value: 0.05, count: 0 },
            { value: 0.10, count: 0 },
            { value: 0.20, count: 0 },
            { value: 0.50, count: 0 },
            { value: 1.00, count: 0 },
            { value: 2.00, count: 0 },
        ],
        bills: [
            { value: 5, count: 0 },
            { value: 10, count: 0 },
            { value: 20, count: 0 },
            { value: 50, count: 0 },
            { value: 100, count: 0 },
            { value: 200, count: 0 },
            { value: 500, count: 0 },
        ],

        get difference() {
            return Math.round((this.closingBalance - this.expectedBalance) * 100) / 100;
        },

        get calculatedTotal() {
            let total = 0;
            this.coins.forEach(coin => {
                total += coin.value * coin.count;
            });
            this.bills.forEach(bill => {
                total += bill.value * bill.count;
            });
            return Math.round(total * 100) / 100;
        },

        updateDenomination(type, value, count) {
            const items = type === 'coin' ? this.coins : this.bills;
            const item = items.find(i => i.value === value);
            if (item) {
                item.count = parseInt(count) || 0;
            }
        },

        useCalculatedTotal() {
            this.closingBalance = this.calculatedTotal;
        },

        getDenominationsData() {
            const data = {};
            this.coins.forEach(coin => {
                if (coin.count > 0) {
                    data[`coin_${coin.value}`] = coin.count;
                }
            });
            this.bills.forEach(bill => {
                if (bill.count > 0) {
                    data[`bill_${bill.value}`] = bill.count;
                }
            });
            return data;
        },

        async submitForm() {
            if (this.requireClosingBalance && !this.closingBalance) {
                await this.showToast('{% trans "Closing balance is required" %}', 'danger');
                return;
            }

            // Confirm if there's a significant difference
            if (Math.abs(this.difference) > 10) {
                const confirmed = await this.showConfirm(
                    '{% trans "Large Discrepancy" %}',
                    `{% trans "There is a difference of" %} ${this.formatCurrency(Math.abs(this.difference))}. {% trans "Are you sure you want to close the session?" %}`
                );

                if (!confirmed) {
                    return;
                }
            }

            this.processing = true;

            // Submit the form normally (no AJAX, let Django handle it)
            document.querySelector('form').submit();
        },

        formatCurrency(amount) {
            const currency = '{{ HUB_CONFIG.currency }}';
            const symbols = {
                'EUR': '€',
                'USD': '$',
                'GBP': '£',
            };
            const symbol = symbols[currency] || currency;
            return symbol + parseFloat(amount).toFixed(2);
        },

        async showToast(message, color = 'primary') {
            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.color = color;
            document.body.appendChild(toast);
            await toast.present();
        },

        async showConfirm(header, message) {
            return new Promise((resolve) => {
                const alert = document.createElement('ion-alert');
                alert.header = header;
                alert.message = message;
                alert.buttons = [
                    {
                        text: '{% trans "Cancel" %}',
                        role: 'cancel',
                        handler: () => resolve(false)
                    },
                    {
                        text: '{% trans "Confirm" %}',
                        role: 'confirm',
                        handler: () => resolve(true)
                    }
                ];
                document.body.appendChild(alert);
                alert.present();
            });
        }
    }
}
</script>
{% endblock %}
