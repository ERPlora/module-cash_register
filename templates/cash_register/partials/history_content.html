{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "cash_register/partials/tabbar_cash_register.html" with current_view='history' %}
</ion-footer>
</div>
{% endif %}

<div class="p-4">
    <div class="mb-6">
        <h1 class="text-3xl font-bold" style="color: var(--ion-text-color);">{% trans "Historial de Sesiones" %}</h1>
        <p class="text-sm mt-2" style="color: var(--ion-color-medium);">{% trans "Todas tus sesiones de caja" %}</p>
    </div>

    <!-- Filters -->
    <ion-card class="m-0 mb-4">
        <ion-card-content>
            <div class="flex flex-wrap gap-4 items-center">
                <ion-segment value="{{ status_filter|default:'all' }}" style="max-width: 300px;">
                    <ion-segment-button value="all"
                        hx-get="{% url 'cash_register:history' %}"
                        hx-target="#dashboard-content"
                        hx-push-url="true">
                        <ion-label>{% trans "Todas" %}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="open"
                        hx-get="{% url 'cash_register:history' %}?status=open"
                        hx-target="#dashboard-content"
                        hx-push-url="true">
                        <ion-label>{% trans "Abiertas" %}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="closed"
                        hx-get="{% url 'cash_register:history' %}?status=closed"
                        hx-target="#dashboard-content"
                        hx-push-url="true">
                        <ion-label>{% trans "Cerradas" %}</ion-label>
                    </ion-segment-button>
                </ion-segment>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Sessions Table -->
    <ion-card class="m-0">
        <ion-card-content class="p-0">
            {% if sessions %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background: var(--ion-color-step-50);">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Sesión" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Estado" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Apertura" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Cierre" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Saldo Inicial" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Saldo Final" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Diferencia" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in sessions %}
                        <tr class="border-b hover:bg-opacity-50" style="border-color: var(--ion-border-color);">
                            <td class="px-4 py-3 text-sm">
                                <a hx-get="{% url 'cash_register:session_detail' session.id %}"
                                   hx-target="#dashboard-content"
                                   hx-push-url="true"
                                   style="color: var(--ion-color-primary); cursor: pointer; font-weight: 500;">
                                    {{ session.session_number }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if session.status == 'open' %}
                                <ion-badge color="success">{% trans "Abierta" %}</ion-badge>
                                {% else %}
                                <ion-badge color="medium">{% trans "Cerrada" %}</ion-badge>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-center text-sm" style="color: var(--ion-text-color);">
                                {{ session.opened_at|date:"d/m/Y H:i" }}
                            </td>
                            <td class="px-4 py-3 text-center text-sm" style="color: var(--ion-text-color);">
                                {% if session.closed_at %}
                                {{ session.closed_at|date:"d/m/Y H:i" }}
                                {% else %}
                                —
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right text-sm" style="color: var(--ion-text-color);">
                                {{ session.opening_balance|floatformat:2 }} €
                            </td>
                            <td class="px-4 py-3 text-right text-sm font-semibold" style="color: var(--ion-text-color);">
                                {% if session.closing_balance %}
                                {{ session.closing_balance|floatformat:2 }} €
                                {% else %}
                                {{ session.get_current_balance|floatformat:2 }} €
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right text-sm font-semibold"
                                style="color: var(--ion-color-{% if session.get_difference >= 0 %}success{% else %}danger{% endif %});">
                                {% if session.status == 'closed' %}
                                {% if session.get_difference > 0 %}+{% endif %}{{ session.get_difference|floatformat:2 }} €
                                {% else %}
                                —
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12" style="color: var(--ion-color-medium);">
                <ion-icon name="time-outline" style="font-size: 64px;"></ion-icon>
                <p class="mt-4 text-lg">{% trans "No hay sesiones registradas" %}</p>
                <ion-button class="mt-4"
                    hx-get="{% url 'cash_register:open_session' %}"
                    hx-target="#dashboard-content"
                    hx-push-url="true">
                    <ion-icon slot="start" name="lock-open-outline"></ion-icon>
                    {% trans "Abrir Primera Sesión" %}
                </ion-button>
            </div>
            {% endif %}
        </ion-card-content>
    </ion-card>
</div>
