{% load static i18n component_tags %}

{% if request.htmx %}
{% component "tabbar" module_id="cash_register" current_view="history" oob=True %}{% endcomponent %}
{% endif %}

<div class="ion-padding" x-data="sessionDetailApp()">
    <!-- Session Header -->
    <ion-card class="mb-4">
        <ion-card-header class="p-0">
            <ion-toolbar>
                <ion-buttons slot="start">
                    <ion-button
                        hx-get="{% url 'cash_register:history' %}"
                        hx-target="#main-content-area"
                        hx-push-url="true"
                        fill="clear">
                        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
                <ion-title>{{ session.session_number }}</ion-title>
                <ion-buttons slot="end">
                    <ion-badge :color="'{{ session.status }}' === 'open' ? 'success' : 'medium'">
                        {% if session.status == 'open' %}
                            {% trans "Open" %}
                        {% else %}
                            {% trans "Closed" %}
                        {% endif %}
                    </ion-badge>
                </ion-buttons>
            </ion-toolbar>
        </ion-card-header>

        <ion-card-content>
            <ion-grid class="p-0">
                <ion-row>
                    <ion-col size="12" size-md="6">
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 mb-3">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">{% trans "Opened At" %}</p>
                            <p class="font-semibold">{{ session.opened_at|date:"d/m/Y H:i:s" }}</p>
                        </div>
                    </ion-col>
                    {% if session.status == 'closed' %}
                    <ion-col size="12" size-md="6">
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-3 mb-3">
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">{% trans "Closed At" %}</p>
                            <p class="font-semibold">{{ session.closed_at|date:"d/m/Y H:i:s" }}</p>
                        </div>
                    </ion-col>
                    {% endif %}
                </ion-row>
            </ion-grid>
        </ion-card-content>
    </ion-card>

    <!-- Financial Summary -->
    <ion-card class="mb-4">
        <ion-card-header>
            <ion-card-title>{% trans "Financial Summary" %}</ion-card-title>
        </ion-card-header>

        <ion-card-content>
            <ion-list>
                <ion-item>
                    <ion-label>{% trans "Opening Balance" %}</ion-label>
                    <ion-note slot="end" class="text-lg font-semibold">
                        {{ HUB_CONFIG.currency }} {{ session.opening_balance }}
                    </ion-note>
                </ion-item>

                <ion-item>
                    <ion-label>
                        <p>{% trans "Total Sales" %}</p>
                        <p class="text-xs text-gray-500">({{ sales_movements.count }} {% trans "transactions" %})</p>
                    </ion-label>
                    <ion-note slot="end" class="text-lg font-semibold text-success">
                        +{{ HUB_CONFIG.currency }} {{ session.get_total_sales }}
                    </ion-note>
                </ion-item>

                <ion-item>
                    <ion-label>
                        <p>{% trans "Cash In" %}</p>
                        <p class="text-xs text-gray-500">({{ in_movements.count }} {% trans "movements" %})</p>
                    </ion-label>
                    <ion-note slot="end" class="text-lg font-semibold text-success">
                        +{{ HUB_CONFIG.currency }} {{ session.get_total_in }}
                    </ion-note>
                </ion-item>

                <ion-item>
                    <ion-label>
                        <p>{% trans "Cash Out" %}</p>
                        <p class="text-xs text-gray-500">({{ out_movements.count }} {% trans "movements" %})</p>
                    </ion-label>
                    <ion-note slot="end" class="text-lg font-semibold text-danger">
                        -{{ HUB_CONFIG.currency }} {{ session.get_total_out|stringformat:".2f"|cut:"-" }}
                    </ion-note>
                </ion-item>

                <ion-item lines="none" color="light">
                    <ion-label>
                        <h2>{% if session.status == 'open' %}{% trans "Current Balance" %}{% else %}{% trans "Expected Balance" %}{% endif %}</h2>
                    </ion-label>
                    <ion-note slot="end" class="text-2xl font-bold text-primary">
                        {{ HUB_CONFIG.currency }}
                        {% if session.status == 'open' %}
                            {{ session.get_current_balance }}
                        {% else %}
                            {{ session.expected_balance }}
                        {% endif %}
                    </ion-note>
                </ion-item>

                {% if session.status == 'closed' %}
                <ion-item>
                    <ion-label>{% trans "Actual Closing Balance" %}</ion-label>
                    <ion-note slot="end" class="text-lg font-semibold">
                        {{ HUB_CONFIG.currency }} {{ session.closing_balance }}
                    </ion-note>
                </ion-item>

                <ion-item lines="none" :color="difference === 0 ? 'success' : (difference > 0 ? 'warning' : 'danger')">
                    <ion-label>
                        <h2>{% trans "Difference" %}</h2>
                    </ion-label>
                    <ion-note slot="end" class="text-2xl font-bold">
                        <span x-show="difference > 0">+</span>
                        {{ HUB_CONFIG.currency }} {{ session.difference }}
                    </ion-note>
                </ion-item>
                {% endif %}
            </ion-list>

            <!-- Notes -->
            {% if session.opening_notes %}
            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                <p class="text-sm font-semibold mb-1">{% trans "Opening Notes" %}</p>
                <p class="text-sm">{{ session.opening_notes }}</p>
            </div>
            {% endif %}

            {% if session.closing_notes %}
            <div class="mt-4 p-3 bg-orange-50 dark:bg-orange-900 rounded-lg">
                <p class="text-sm font-semibold mb-1">{% trans "Closing Notes" %}</p>
                <p class="text-sm">{{ session.closing_notes }}</p>
            </div>
            {% endif %}
        </ion-card-content>
    </ion-card>

    <!-- Cash Movements -->
    <ion-card class="mb-4">
        <ion-card-header>
            <div class="flex justify-between items-center">
                <ion-card-title>{% trans "Cash Movements" %}</ion-card-title>
                <ion-badge color="primary">{{ movements.count }}</ion-badge>
            </div>
        </ion-card-header>

        <ion-card-content>
            <ion-segment x-model="movementFilter">
                <ion-segment-button value="all">
                    <ion-label>{% trans "All" %} ({{ movements.count }})</ion-label>
                </ion-segment-button>
                <ion-segment-button value="sale">
                    <ion-label>{% trans "Sales" %} ({{ sales_movements.count }})</ion-label>
                </ion-segment-button>
                <ion-segment-button value="in">
                    <ion-label>{% trans "In" %} ({{ in_movements.count }})</ion-label>
                </ion-segment-button>
                <ion-segment-button value="out">
                    <ion-label>{% trans "Out" %} ({{ out_movements.count }})</ion-label>
                </ion-segment-button>
            </ion-segment>

            <ion-list class="mt-4">
                {% if movements %}
                    {% for movement in movements %}
                    <ion-item
                        x-show="movementFilter === 'all' || movementFilter === '{{ movement.movement_type }}'"
                        lines="full">
                        <ion-icon
                            slot="start"
                            :name="'{{ movement.movement_type }}' === 'sale' ? 'cart-outline' : ('{{ movement.movement_type }}' === 'in' ? 'arrow-down-circle-outline' : 'arrow-up-circle-outline')"
                            :color="'{{ movement.movement_type }}' === 'out' ? 'danger' : 'success'">
                        </ion-icon>
                        <ion-label>
                            <h3>
                                {% if movement.movement_type == 'sale' %}
                                    {% trans "Sale" %}
                                {% elif movement.movement_type == 'in' %}
                                    {% trans "Cash In" %}
                                {% else %}
                                    {% trans "Cash Out" %}
                                {% endif %}
                            </h3>
                            <p>{{ movement.description }}</p>
                            {% if movement.sale_reference %}
                            <p class="text-xs text-gray-500">
                                {% trans "Sale" %}: {{ movement.sale_reference }}
                            </p>
                            {% endif %}
                            <p class="text-xs text-gray-500">{{ movement.created_at|date:"d/m/Y H:i" }}</p>
                        </ion-label>
                        <ion-note slot="end" :class="'{{ movement.amount }}' < 0 ? 'text-danger' : 'text-success'" class="text-lg font-semibold">
                            {% if movement.amount >= 0 %}+{% endif %}{{ HUB_CONFIG.currency }} {{ movement.amount }}
                        </ion-note>
                    </ion-item>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-8">
                        <ion-icon name="folder-open-outline" class="text-6xl text-gray-400 mb-2"></ion-icon>
                        <p class="text-gray-500">{% trans "No movements in this session" %}</p>
                    </div>
                {% endif %}
            </ion-list>
        </ion-card-content>
    </ion-card>

    <!-- Cash Counts (Opening/Closing) -->
    {% if counts %}
    <ion-card class="mb-4">
        <ion-card-header>
            <ion-card-title>{% trans "Cash Counts" %}</ion-card-title>
        </ion-card-header>

        <ion-card-content>
            {% for count in counts %}
            <div class="mb-4 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-semibold">
                        {% if count.count_type == 'opening' %}
                            {% trans "Opening Count" %}
                        {% else %}
                            {% trans "Closing Count" %}
                        {% endif %}
                    </h3>
                    <span class="text-lg font-bold">{{ HUB_CONFIG.currency }} {{ count.total }}</span>
                </div>
                <p class="text-xs text-gray-500 mb-2">{{ count.created_at|date:"d/m/Y H:i" }}</p>

                {% if count.notes %}
                <p class="text-sm italic mb-2">{{ count.notes }}</p>
                {% endif %}

                {% if count.denominations %}
                <details class="mt-2">
                    <summary class="cursor-pointer text-sm text-primary">{% trans "View denominations" %}</summary>
                    <div class="mt-2 text-sm">
                        {% for key, value in count.denominations.items %}
                        <div class="flex justify-between py-1">
                            <span>{{ key }}</span>
                            <span>{{ value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
            </div>
            {% endfor %}
        </ion-card-content>
    </ion-card>
    {% endif %}

    <!-- Action Buttons -->
    {% if session.status == 'open' %}
    <div class="mt-4 flex gap-3">
        <ion-button
            hx-get="{% url 'cash_register:close_session' %}"
            hx-target="#main-content-area"
            hx-push-url="true"
            expand="block"
            color="danger"
            class="flex-1">
            <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
            {% trans "Close Session" %}
        </ion-button>
    </div>
    {% endif %}
</div>

<script>
function sessionDetailApp() {
    return {
        movementFilter: 'all',
        difference: {{ session.difference|default:"0" }},

        init() {
            console.log('[SESSION DETAIL] Initialized');
        }
    }
}
</script>
