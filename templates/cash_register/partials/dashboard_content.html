{% load i18n ui component_tags %}

{% if request.htmx %}
{% component "tabbar" module_id="cash_register" current_view="dashboard" oob=True %}{% endcomponent %}
{% endif %}

{% ui_page_header title=_("Cash Register") subtitle=_("Session and movement management") %}

<div class="ion-padding">

    <!-- Stats Cards -->
    <ion-row class="mb-md">
        <ion-col size="6" size-md="3">
            {% if open_session %}
                {% ui_stat_card value=_("Open") label=_("Status") icon="cash-outline" color="success" %}
            {% else %}
                {% ui_stat_card value=_("Closed") label=_("Status") icon="cash-outline" color="medium" %}
            {% endif %}
        </ion-col>
        {% if open_session %}
        <ion-col size="6" size-md="3">
            {% ui_stat_card value=current_balance_formatted label=_("Current Balance") icon="wallet-outline" color="primary" %}
        </ion-col>
        <ion-col size="6" size-md="3">
            {% ui_stat_card value=total_sales_formatted label=_("Sales") icon="trending-up-outline" color="success" %}
        </ion-col>
        <ion-col size="6" size-md="3">
            {% ui_stat_card value=open_session.get_duration label=_("Duration") icon="time-outline" color="warning" %}
        </ion-col>
        {% endif %}
    </ion-row>

    <!-- Current Session Summary -->
    {% if open_session %}
    {% ui_card title=_("Current Session") css_class="mb-md" %}
        <div class="d-flex justify-between align-center p-sm rounded-md mb-md" style="background: var(--ion-color-light);">
            <div>
                <div class="fw-medium">{{ open_session.session_number }}</div>
                <div class="fs-xs text-secondary">
                    {% trans "Opened" %}: {{ open_session.opened_at|date:"d/m/Y H:i" }}
                </div>
            </div>
            <ion-badge color="success">{% trans "Active" %}</ion-badge>
        </div>

        <ion-list lines="full" class="mb-md">
            <ion-item>
                <ion-label>
                    <p>{% trans "Opening Balance" %}</p>
                </ion-label>
                <ion-note slot="end">
                    <strong>{{ opening_balance_formatted }}</strong>
                </ion-note>
            </ion-item>

            <ion-item>
                <ion-label>
                    <p>{% trans "Sales" %}</p>
                </ion-label>
                <ion-note slot="end" color="success">
                    <strong>+{{ total_sales_formatted }}</strong>
                </ion-note>
            </ion-item>

            <ion-item>
                <ion-label>
                    <p>{% trans "Cash In" %}</p>
                </ion-label>
                <ion-note slot="end" color="success">
                    <strong>+{{ total_in_formatted }}</strong>
                </ion-note>
            </ion-item>

            <ion-item>
                <ion-label>
                    <p>{% trans "Cash Out" %}</p>
                </ion-label>
                <ion-note slot="end" color="danger">
                    <strong>-{{ total_out_formatted }}</strong>
                </ion-note>
            </ion-item>

            <ion-item lines="none" style="--background: var(--ion-color-light);">
                <ion-label>
                    <h2><strong>{% trans "Current Balance" %}</strong></h2>
                </ion-label>
                <ion-note slot="end" color="primary">
                    <h2><strong>{{ current_balance_formatted }}</strong></h2>
                </ion-note>
            </ion-item>
        </ion-list>

        <div class="d-flex gap-sm justify-center">
            <ion-button
                hx-get="{% url 'sales:pos' %}"
                hx-target="#main-content-area"
                hx-push-url="true">
                <ion-icon slot="start" name="cart-outline"></ion-icon>
                {% trans "Go to POS" %}
            </ion-button>
            <ion-button fill="outline" color="danger"
                hx-get="{% url 'cash_register:close_session' %}"
                hx-target="#main-content-area"
                hx-push-url="true">
                <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
                {% trans "Close Register" %}
            </ion-button>
        </div>
    {% endui_card %}
    {% else %}
    {% ui_card title=_("No Open Session") css_class="mb-md" %}
        {% ui_empty_state title=_("Register is closed") description=_("Open a session to start recording sales") icon="lock-closed-outline" action_label=_("Open Register") action_url=open_session_url %}
    {% endui_card %}
    {% endif %}

    <!-- Today's Sessions -->
    {% if today_sessions %}
    {% ui_card title=_("Today's Sessions") %}
        <div class="data-table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>{% trans "Session" %}</th>
                        <th class="cell-center">{% trans "Opened" %}</th>
                        <th class="cell-center">{% trans "Closed" %}</th>
                        <th class="cell-right">{% trans "Final Balance" %}</th>
                        <th class="cell-right">{% trans "Difference" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in today_sessions %}
                    <tr>
                        <td>
                            <a hx-get="{% url 'cash_register:session_detail' session.id %}"
                               hx-target="#main-content-area"
                               hx-push-url="true"
                               class="text-primary cursor-pointer">
                                {{ session.session_number }}
                            </a>
                        </td>
                        <td class="cell-center">{{ session.opened_at|date:"H:i" }}</td>
                        <td class="cell-center">{{ session.closed_at|date:"H:i"|default:"-" }}</td>
                        <td class="cell-right fw-semibold">{{ session.closing_balance_formatted }}</td>
                        <td class="cell-right fw-semibold {% if session.difference >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if session.difference > 0 %}+{% endif %}{{ session.difference_formatted }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endui_card %}
    {% endif %}
</div>
