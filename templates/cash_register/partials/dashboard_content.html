{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
<ion-footer>
{% include "cash_register/partials/tabbar_cash_register.html" with current_view='dashboard' %}
</ion-footer>
</div>
{% endif %}

<div class="p-4">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold" style="color: var(--ion-text-color);">{% trans "Caja Registradora" %}</h1>
        <p class="text-sm mt-2" style="color: var(--ion-color-medium);">{% trans "Gestión de sesiones y movimientos de caja" %}</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: var(--ion-color-{% if open_session %}success{% else %}medium{% endif %}-tint);">
                        <ion-icon name="cash-outline" style="font-size: 24px; color: var(--ion-color-{% if open_session %}success{% else %}medium{% endif %});"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--ion-color-medium);">{% trans "Estado" %}</div>
                        <div class="text-2xl font-semibold" style="color: var(--ion-text-color);">
                            {% if open_session %}{% trans "Abierta" %}{% else %}{% trans "Cerrada" %}{% endif %}
                        </div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        {% if open_session %}
        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: var(--ion-color-primary-tint);">
                        <ion-icon name="wallet-outline" style="font-size: 24px; color: var(--ion-color-primary);"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--ion-color-medium);">{% trans "Saldo Actual" %}</div>
                        <div class="text-2xl font-semibold" style="color: var(--ion-text-color);">{{ open_session.get_current_balance|floatformat:2 }} €</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: var(--ion-color-success-tint);">
                        <ion-icon name="trending-up-outline" style="font-size: 24px; color: var(--ion-color-success);"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--ion-color-medium);">{% trans "Ventas" %}</div>
                        <div class="text-2xl font-semibold" style="color: var(--ion-color-success);">{{ open_session.get_total_sales|floatformat:2 }} €</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="m-0">
            <ion-card-content class="p-6">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: var(--ion-color-warning-tint);">
                        <ion-icon name="time-outline" style="font-size: 24px; color: var(--ion-color-warning);"></ion-icon>
                    </div>
                    <div>
                        <div class="text-sm" style="color: var(--ion-color-medium);">{% trans "Duración" %}</div>
                        <div class="text-2xl font-semibold" style="color: var(--ion-text-color);">{{ open_session.get_duration }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
        {% endif %}
    </div>

    <!-- Current Session Summary -->
    <div class="mb-6">
        <ion-card class="m-0">
            <ion-card-header>
                <ion-card-title>{% if open_session %}{% trans "Sesión Actual" %}{% else %}{% trans "Sin Sesión Abierta" %}{% endif %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                {% if open_session %}
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--ion-color-light);">
                        <div>
                            <div class="font-medium" style="color: var(--ion-text-color);">{{ open_session.session_number }}</div>
                            <div class="text-xs" style="color: var(--ion-color-medium);">
                                {% trans "Abierta" %}: {{ open_session.opened_at|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                        <ion-badge color="success">{% trans "Activa" %}</ion-badge>
                    </div>

                    <ion-list>
                        <ion-item>
                            <ion-label>
                                <p>{% trans "Saldo Inicial" %}</p>
                            </ion-label>
                            <ion-note slot="end">
                                <strong>{{ open_session.opening_balance|floatformat:2 }} €</strong>
                            </ion-note>
                        </ion-item>

                        <ion-item>
                            <ion-label>
                                <p>{% trans "Ventas" %}</p>
                            </ion-label>
                            <ion-note slot="end" color="success">
                                <strong>+{{ open_session.get_total_sales|floatformat:2 }} €</strong>
                            </ion-note>
                        </ion-item>

                        <ion-item>
                            <ion-label>
                                <p>{% trans "Entradas" %}</p>
                            </ion-label>
                            <ion-note slot="end" color="success">
                                <strong>+{{ open_session.get_total_in|floatformat:2 }} €</strong>
                            </ion-note>
                        </ion-item>

                        <ion-item>
                            <ion-label>
                                <p>{% trans "Salidas" %}</p>
                            </ion-label>
                            <ion-note slot="end" color="danger">
                                <strong>-{{ open_session.get_total_out|floatformat:2 }} €</strong>
                            </ion-note>
                        </ion-item>

                        <ion-item lines="none" style="--background: var(--ion-color-light);">
                            <ion-label>
                                <h2><strong>{% trans "Saldo Actual" %}</strong></h2>
                            </ion-label>
                            <ion-note slot="end" color="primary">
                                <h2><strong>{{ open_session.get_current_balance|floatformat:2 }} €</strong></h2>
                            </ion-note>
                        </ion-item>
                    </ion-list>

                    <div class="flex gap-2 justify-center pt-4">
                        <ion-button
                            hx-get="{% url 'sales:pos' %}"
                            hx-target="#dashboard-content"
                            hx-push-url="true">
                            <ion-icon slot="start" name="cart-outline"></ion-icon>
                            {% trans "Ir al POS" %}
                        </ion-button>
                        <ion-button fill="outline" color="danger"
                            hx-get="{% url 'cash_register:close_session' %}"
                            hx-target="#dashboard-content"
                            hx-push-url="true">
                            <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
                            {% trans "Cerrar Caja" %}
                        </ion-button>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8" style="color: var(--ion-color-medium);">
                    <ion-icon name="lock-closed-outline" style="font-size: 64px;"></ion-icon>
                    <p class="mt-4 text-lg">{% trans "La caja está cerrada" %}</p>
                    <p class="mt-2">{% trans "Abre una sesión para comenzar a registrar ventas" %}</p>
                    <ion-button class="mt-4"
                        hx-get="{% url 'cash_register:open_session' %}"
                        hx-target="#dashboard-content"
                        hx-push-url="true">
                        <ion-icon slot="start" name="lock-open-outline"></ion-icon>
                        {% trans "Abrir Caja" %}
                    </ion-button>
                </div>
                {% endif %}
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Today's Sessions -->
    {% if today_sessions %}
    <ion-card class="m-0">
        <ion-card-header>
            <div class="flex justify-between items-center">
                <ion-card-title>{% trans "Sesiones de Hoy" %}</ion-card-title>
                <ion-badge color="primary">{{ today_sessions.count }}</ion-badge>
            </div>
        </ion-card-header>
        <ion-card-content class="p-0">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead style="background: var(--ion-color-step-50);">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Sesión" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Apertura" %}</th>
                            <th class="px-4 py-3 text-center text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Cierre" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Saldo Final" %}</th>
                            <th class="px-4 py-3 text-right text-sm font-medium" style="color: var(--ion-color-medium);">{% trans "Diferencia" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for session in today_sessions %}
                        <tr class="border-b" style="border-color: var(--ion-border-color);">
                            <td class="px-4 py-3 text-sm">
                                <a hx-get="{% url 'cash_register:session_detail' session.id %}"
                                   hx-target="#dashboard-content"
                                   hx-push-url="true"
                                   style="color: var(--ion-color-primary); cursor: pointer;">
                                    {{ session.session_number }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-center text-sm">{{ session.opened_at|date:"H:i" }}</td>
                            <td class="px-4 py-3 text-center text-sm">{{ session.closed_at|date:"H:i" }}</td>
                            <td class="px-4 py-3 text-right text-sm font-semibold">{{ session.closing_balance|floatformat:2 }} €</td>
                            <td class="px-4 py-3 text-right text-sm font-semibold" style="color: var(--ion-color-{% if session.get_difference >= 0 %}success{% else %}danger{% endif %});">
                                {% if session.get_difference > 0 %}+{% endif %}{{ session.get_difference|floatformat:2 }} €
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </ion-card-content>
    </ion-card>
    {% endif %}
</div>
