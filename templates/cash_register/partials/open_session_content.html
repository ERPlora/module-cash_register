{% load i18n %}

<div class="p-4" x-data="openSessionApp()">
    <ion-card>
        <ion-card-header>
            <ion-card-title>{% trans "Open Cash Session" %}</ion-card-title>
            <ion-card-subtitle>{{ request.user.first_name }} {{ request.user.last_name }}</ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>
            <!-- Previous Session Info -->
            {% if last_session %}
            <ion-card color="light" class="mb-4">
                <ion-card-content>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{% trans "Last Session" %}</p>
                            <p class="font-semibold">{{ last_session.session_number }}</p>
                            <p class="text-sm">
                                {% trans "Closed:" %}
                                <span class="text-gray-600">{{ last_session.closed_at|date:"d/m/Y H:i" }}</span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600 dark:text-gray-400">{% trans "Closing Balance" %}</p>
                            <p class="text-2xl font-bold text-primary">
                                {{ HUB_CONFIG.currency }} {{ suggested_balance }}
                            </p>
                        </div>
                    </div>
                </ion-card-content>
            </ion-card>
            {% endif %}

            <!-- Opening Balance Form -->
            <form method="POST">
                {% csrf_token %}

                <ion-item>
                    <ion-label position="stacked">
                        {% trans "Opening Balance" %}
                        {% if config.require_opening_balance %}<span class="text-danger">*</span>{% endif %}
                    </ion-label>
                    <ion-input
                        name="opening_balance"
                        type="number"
                        step="0.01"
                        x-model="openingBalance"
                        :required="requireOpeningBalance"
                        placeholder="0.00">
                    </ion-input>
                </ion-item>

                <ion-item class="mt-3">
                    <ion-label position="stacked">{% trans "Notes (Optional)" %}</ion-label>
                    <ion-textarea
                        name="notes"
                        x-model="notes"
                        rows="3"
                        placeholder="{% trans "Any additional notes..." %}">
                    </ion-textarea>
                </ion-item>

                <!-- Denomination Counter (Optional) -->
                <div class="mt-4">
                    <ion-button
                        @click="showDenominationCounter = !showDenominationCounter"
                        fill="outline"
                        expand="block">
                        <ion-icon slot="start" name="calculator-outline"></ion-icon>
                        <span x-text="showDenominationCounter ? '{% trans "Hide Calculator" %}' : '{% trans "Count Denominations" %}'"></span>
                    </ion-button>
                </div>

                <!-- Denomination Counter Expanded -->
                <div x-show="showDenominationCounter" class="mt-4" x-transition>
                    <ion-card>
                        <ion-card-header>
                            <ion-card-subtitle>{% trans "Cash Count" %}</ion-card-subtitle>
                        </ion-card-header>
                        <ion-card-content>
                            <!-- Coins -->
                            <p class="font-semibold mb-2">{% trans "Coins" %}</p>
                            <ion-grid class="p-0">
                                <ion-row>
                                    <template x-for="coin in coins" :key="coin.value">
                                        <ion-col size="6" size-md="4">
                                            <ion-item>
                                                <ion-label>
                                                    <span x-text="formatCurrency(coin.value)"></span>
                                                </ion-label>
                                                <ion-input
                                                    type="number"
                                                    min="0"
                                                    :value="coin.count"
                                                    @ionInput="updateDenomination('coin', coin.value, $event.target.value)"
                                                    placeholder="0">
                                                </ion-input>
                                            </ion-item>
                                        </ion-col>
                                    </template>
                                </ion-row>
                            </ion-grid>

                            <!-- Bills -->
                            <p class="font-semibold mb-2 mt-4">{% trans "Bills" %}</p>
                            <ion-grid class="p-0">
                                <ion-row>
                                    <template x-for="bill in bills" :key="bill.value">
                                        <ion-col size="6" size-md="4">
                                            <ion-item>
                                                <ion-label>
                                                    <span x-text="formatCurrency(bill.value)"></span>
                                                </ion-label>
                                                <ion-input
                                                    type="number"
                                                    min="0"
                                                    :value="bill.count"
                                                    @ionInput="updateDenomination('bill', bill.value, $event.target.value)"
                                                    placeholder="0">
                                                </ion-input>
                                            </ion-item>
                                        </ion-col>
                                    </template>
                                </ion-row>
                            </ion-grid>

                            <!-- Calculated Total -->
                            <ion-item class="mt-4" color="primary">
                                <ion-label>
                                    <h2>{% trans "Calculated Total" %}</h2>
                                </ion-label>
                                <ion-note slot="end" class="text-xl font-bold">
                                    <span x-text="formatCurrency(calculatedTotal)"></span>
                                </ion-note>
                            </ion-item>

                            <ion-button
                                @click="useCalculatedTotal()"
                                expand="block"
                                fill="outline"
                                class="mt-2">
                                {% trans "Use This Amount" %}
                            </ion-button>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- Hidden field for denominations JSON -->
                <input type="hidden" name="denominations_json" :value="JSON.stringify(getDenominationsData())">

                <!-- Action Buttons -->
                <div class="mt-6 flex gap-3">
                    <ion-button
                        hx-get="{% url 'cash_register:dashboard' %}"
                        hx-target="#main-content-area"
                        hx-push-url="true"
                        fill="outline"
                        expand="block"
                        class="flex-1">
                        {% trans "Cancel" %}
                    </ion-button>
                    <ion-button
                        type="submit"
                        expand="block"
                        class="flex-1"
                        color="success">
                        <ion-icon slot="start" name="cash-outline"></ion-icon>
                        {% trans "Open Session" %}
                    </ion-button>
                </div>
            </form>
        </ion-card-content>
    </ion-card>
</div>
