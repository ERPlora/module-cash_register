{% load i18n djicons %}

<script>
function closeSessionApp() {
    return {
        expectedBalance: {{ expected_balance }},
        closingBalance: {{ expected_balance }},
        notes: '',
        processing: false,
        requireClosingBalance: {{ config.require_closing_balance|yesno:"true,false" }},
        showDenominationCounter: false,
        coins: [
            { value: 0.01, count: 0 }, { value: 0.02, count: 0 },
            { value: 0.05, count: 0 }, { value: 0.10, count: 0 },
            { value: 0.20, count: 0 }, { value: 0.50, count: 0 },
            { value: 1.00, count: 0 }, { value: 2.00, count: 0 },
        ],
        bills: [
            { value: 5, count: 0 }, { value: 10, count: 0 },
            { value: 20, count: 0 }, { value: 50, count: 0 },
            { value: 100, count: 0 }, { value: 200, count: 0 },
            { value: 500, count: 0 },
        ],
        get difference() { return Math.round((this.closingBalance - this.expectedBalance) * 100) / 100; },
        get calculatedTotal() {
            let total = 0;
            this.coins.forEach(coin => { total += coin.value * coin.count; });
            this.bills.forEach(bill => { total += bill.value * bill.count; });
            return Math.round(total * 100) / 100;
        },
        updateDenomination(type, value, count) {
            const items = type === 'coin' ? this.coins : this.bills;
            const item = items.find(i => i.value === value);
            if (item) item.count = parseInt(count) || 0;
        },
        useCalculatedTotal() { this.closingBalance = this.calculatedTotal; },
        getDenominationsData() {
            const data = {};
            this.coins.forEach(coin => { if (coin.count > 0) data[`coin_${coin.value}`] = coin.count; });
            this.bills.forEach(bill => { if (bill.count > 0) data[`bill_${bill.value}`] = bill.count; });
            return data;
        },
        async submitForm() {
            if (this.requireClosingBalance && !this.closingBalance) return;
            if (Math.abs(this.difference) > 10) {
                if (!confirm('{% trans "Large Discrepancy" %}\n\n{% trans "There is a significant difference. Are you sure you want to close the session?" %}')) return;
            }
            this.processing = true;
            document.querySelector('form').submit();
        },
        formatCurrency(amount) {
            const currency = '{{ HUB_CONFIG.currency }}';
            const symbols = { 'EUR': '\u20ac', 'USD': '$', 'GBP': '\u00a3' };
            return (symbols[currency] || currency) + ' ' + parseFloat(amount).toFixed(2);
        },
    }
}
</script>

<div class="p-4" x-data="closeSessionApp()">
    <!-- Back Button -->
    <button type="button"
            hx-get="{% url 'cash_register:dashboard' %}"
            hx-target="#main-content-area" hx-push-url="true"
            class="btn btn-ghost mb-3">
        {% icon "arrow-back-outline" %} {% trans "Back to Dashboard" %}
    </button>

    <div class="card mb-4">
        <div class="card-header">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="card-title">{% trans "Close Cash Session" %}</h2>
                    <p class="text-sm opacity-60">{{ session.session_number }}</p>
                </div>
                <span class="badge color-success">{% trans "Open" %}</span>
            </div>
        </div>

        <div class="card-body">
            <!-- Session Summary -->
            <div class="card mb-4" style="background: var(--color-base-200);">
                <div class="card-body">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <p class="text-xs text-muted">{% trans "Opened At" %}</p>
                            <p class="font-semibold">{{ session.opened_at|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-muted">{% trans "Opening Balance" %}</p>
                            <p class="font-semibold">{{ session.opening_balance|floatformat:2 }}</p>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg" style="background: var(--color-base-200);">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">{% trans "Total Sales" %}</span>
                            <span class="font-semibold text-success">+{{ session.get_total_sales|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">{% trans "Cash In" %}</span>
                            <span class="font-semibold text-success">+{{ session.get_total_in|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">{% trans "Cash Out" %}</span>
                            <span class="font-semibold text-error">-{{ session.get_total_out|floatformat:2 }}</span>
                        </div>
                        <hr class="my-2" style="border-color: var(--color-base-300);">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">{% trans "Expected Balance" %}</span>
                            <span class="text-xl font-bold text-primary">{{ expected_balance|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <form method="POST" @submit.prevent="submitForm()">
                {% csrf_token %}

                <div class="form-group mb-3">
                    <label class="form-group-label">
                        {% trans "Actual Closing Balance" %}
                        {% if config.require_closing_balance %}<span class="text-error">*</span>{% endif %}
                    </label>
                    <input class="input" name="closing_balance" type="number" step="0.01"
                           x-model="closingBalance"
                           :required="requireClosingBalance"
                           placeholder="0.00">
                </div>

                <!-- Difference indicator -->
                <div x-show="closingBalance > 0" class="mb-4" x-transition>
                    <div class="p-3 rounded-lg" :class="difference === 0 ? 'bg-success/10' : (difference > 0 ? 'bg-warning/10' : 'bg-error/10')">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs text-muted">{% trans "Difference" %}</p>
                                <p class="text-2xl font-bold" :class="difference === 0 ? 'text-success' : (difference > 0 ? 'text-warning' : 'text-error')" x-text="formatCurrency(Math.abs(difference))"></p>
                            </div>
                            <div class="text-right">
                                <template x-if="difference === 0"><span class="badge color-success">{% trans "Exact!" %}</span></template>
                                <template x-if="difference > 0"><span class="badge color-warning">{% trans "Surplus" %}</span></template>
                                <template x-if="difference < 0"><span class="badge color-error">{% trans "Shortage" %}</span></template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Denomination Counter Toggle -->
                <div class="mb-4">
                    <button type="button"
                        @click="showDenominationCounter = !showDenominationCounter"
                        class="btn btn-outline btn-block">
                        {% icon "calculator-outline" %}
                        <span x-text="showDenominationCounter ? '{% trans "Hide Calculator" %}' : '{% trans "Count Denominations" %}'"></span>
                    </button>
                </div>

                <!-- Denomination Calculator -->
                <div x-show="showDenominationCounter" class="mb-4" x-transition>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">{% trans "Cash Count" %}</h3>
                        </div>
                        <div class="card-body">
                            <p class="font-semibold mb-2">{% trans "Coins" %}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <template x-for="coin in coins" :key="coin.value">
                                    <div class="form-group">
                                        <label class="form-group-label text-sm" x-text="formatCurrency(coin.value)"></label>
                                        <input class="input input--sm" type="number" min="0" :value="coin.count"
                                            @input="updateDenomination('coin', coin.value, $event.target.value)" placeholder="0">
                                    </div>
                                </template>
                            </div>

                            <p class="font-semibold mb-2 mt-4">{% trans "Bills" %}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                <template x-for="bill in bills" :key="bill.value">
                                    <div class="form-group">
                                        <label class="form-group-label text-sm" x-text="formatCurrency(bill.value)"></label>
                                        <input class="input input--sm" type="number" min="0" :value="bill.count"
                                            @input="updateDenomination('bill', bill.value, $event.target.value)" placeholder="0">
                                    </div>
                                </template>
                            </div>

                            <div class="flex justify-between items-center mt-4 p-3 rounded-lg bg-primary/10">
                                <span class="font-semibold">{% trans "Calculated Total" %}</span>
                                <span class="text-xl font-bold text-primary" x-text="formatCurrency(calculatedTotal)"></span>
                            </div>

                            <button type="button" class="btn btn-outline btn-block mt-2"
                                @click="useCalculatedTotal()">
                                {% trans "Use This Amount" %}
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-group-label">{% trans "Closing Notes (Optional)" %}</label>
                    <textarea class="textarea" name="notes" x-model="notes" rows="3"
                        placeholder="{% trans "Any discrepancies or notes..." %}"></textarea>
                </div>

                <input type="hidden" name="denominations_json" :value="JSON.stringify(getDenominationsData())">

                <div class="flex gap-3">
                    <button type="button" class="btn btn-outline flex-1"
                        hx-get="{% url 'cash_register:dashboard' %}"
                        hx-target="#main-content-area" hx-push-url="true">
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn color-error flex-1" :disabled="processing">
                        {% icon "lock-closed-outline" %}
                        <span x-show="!processing">{% trans "Close Session" %}</span>
                        <span x-show="processing">{% trans "Closing..." %}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
