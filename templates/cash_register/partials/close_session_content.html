{% load i18n component_tags %}

{% component "page"
    title=_("Close Cash Session")
    module_id="cash_register"
    tabbar_view="dashboard" %}

    {% fill "content" %}
        <ion-card>
        <ion-card-header>
            <ion-card-title>{% trans "Close Cash Session" %}</ion-card-title>
            <ion-card-subtitle>{{ session.session_number }}</ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>
            <!-- Session Summary -->
            <ion-card color="light" class="mb-4">
                <ion-card-content>
                    <ion-grid class="p-0">
                        <ion-row>
                            <ion-col size="6">
                                <p class="text-sm text-gray-600 dark:text-gray-400">{% trans "Opened At" %}</p>
                                <p class="font-semibold">{{ session.opened_at|date:"d/m/Y H:i" }}</p>
                            </ion-col>
                            <ion-col size="6" class="text-right">
                                <p class="text-sm text-gray-600 dark:text-gray-400">{% trans "Opening Balance" %}</p>
                                <p class="font-semibold">{{ HUB_CONFIG.currency }} {{ session.opening_balance }}</p>
                            </ion-col>
                        </ion-row>

                        <ion-row class="mt-3">
                            <ion-col size="12">
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-3">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm">{% trans "Total Sales" %}</span>
                                        <span class="font-semibold text-success">
                                            +{{ HUB_CONFIG.currency }} {{ session.get_total_sales }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm">{% trans "Cash In" %}</span>
                                        <span class="font-semibold text-success">
                                            +{{ HUB_CONFIG.currency }} {{ session.get_total_in }}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm">{% trans "Cash Out" %}</span>
                                        <span class="font-semibold text-danger">
                                            -{{ HUB_CONFIG.currency }} {{ session.get_total_out|stringformat:".2f"|cut:"-" }}
                                        </span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold">{% trans "Expected Balance" %}</span>
                                        <span class="text-xl font-bold text-primary">
                                            {{ HUB_CONFIG.currency }} {{ expected_balance }}
                                        </span>
                                    </div>
                                </div>
                            </ion-col>
                        </ion-row>
                    </ion-grid>
                </ion-card-content>
            </ion-card>

            <!-- Closing Balance Form -->
            <form method="POST"
                  hx-post="{% url 'cash_register:api_close_session' %}"
                  hx-target="#main-content-area"
                  hx-push-url="{% url 'cash_register:dashboard' %}">
                {% csrf_token %}
                <input type="hidden" name="expected_balance" value="{{ expected_balance }}">

                <ion-item>
                    <ion-label position="stacked">
                        {% trans "Actual Closing Balance" %}
                        {% if config.require_closing_balance %}<span class="text-danger">*</span>{% endif %}
                    </ion-label>
                    <ion-input
                        id="closing-balance-input"
                        name="closing_balance"
                        type="number"
                        step="0.01"
                        {% if config.require_closing_balance %}required{% endif %}
                        placeholder="0.00"
                        hx-get="{% url 'cash_register:htmx_calculate_difference' %}"
                        hx-trigger="input changed delay:300ms"
                        hx-target="#difference-indicator"
                        hx-include="[name='expected_balance']">
                    </ion-input>
                </ion-item>

                <!-- Difference Indicator (HTMX updated) -->
                <div id="difference-indicator" class="mt-3">
                    <!-- Will be populated by HTMX when closing_balance is entered -->
                </div>

                <!-- Denomination Counter Toggle -->
                <div class="mt-4">
                    <ion-button
                        id="denomination-toggle"
                        fill="outline"
                        expand="block"
                        onclick="toggleDenominationCounter()">
                        <ion-icon slot="start" name="calculator-outline"></ion-icon>
                        <span>{% trans "Count Denominations" %}</span>
                    </ion-button>
                </div>

                <!-- Denomination Counter (hidden by default) -->
                <div id="denomination-counter" class="mt-4" style="display: none;">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-subtitle>{% trans "Cash Count" %}</ion-card-subtitle>
                        </ion-card-header>
                        <ion-card-content>
                            <!-- Coins -->
                            <p class="font-semibold mb-2">{% trans "Coins" %}</p>
                            <ion-grid class="p-0">
                                <ion-row>
                                    {% for coin in coins %}
                                    <ion-col size="6" size-md="4">
                                        <ion-item>
                                            <ion-label>{{ HUB_CONFIG.currency }} {{ coin }}</ion-label>
                                            <ion-input
                                                type="number"
                                                min="0"
                                                name="coin_{{ coin|stringformat:'.2f'|cut:'.' }}"
                                                class="denomination-input"
                                                data-value="{{ coin }}"
                                                placeholder="0"
                                                hx-get="{% url 'cash_register:htmx_calculate_denominations' %}"
                                                hx-trigger="input changed delay:200ms"
                                                hx-target="#calculated-total"
                                                hx-include=".denomination-input">
                                            </ion-input>
                                        </ion-item>
                                    </ion-col>
                                    {% endfor %}
                                </ion-row>
                            </ion-grid>

                            <!-- Bills -->
                            <p class="font-semibold mb-2 mt-4">{% trans "Bills" %}</p>
                            <ion-grid class="p-0">
                                <ion-row>
                                    {% for bill in bills %}
                                    <ion-col size="6" size-md="4">
                                        <ion-item>
                                            <ion-label>{{ HUB_CONFIG.currency }} {{ bill }}</ion-label>
                                            <ion-input
                                                type="number"
                                                min="0"
                                                name="bill_{{ bill }}"
                                                class="denomination-input"
                                                data-value="{{ bill }}"
                                                placeholder="0"
                                                hx-get="{% url 'cash_register:htmx_calculate_denominations' %}"
                                                hx-trigger="input changed delay:200ms"
                                                hx-target="#calculated-total"
                                                hx-include=".denomination-input">
                                            </ion-input>
                                        </ion-item>
                                    </ion-col>
                                    {% endfor %}
                                </ion-row>
                            </ion-grid>

                            <!-- Calculated Total (HTMX updated) -->
                            <div id="calculated-total">
                                <ion-item class="mt-4" color="primary">
                                    <ion-label>
                                        <h2>{% trans "Calculated Total" %}</h2>
                                    </ion-label>
                                    <ion-note slot="end" class="text-xl font-bold">
                                        {{ HUB_CONFIG.currency }} 0.00
                                    </ion-note>
                                </ion-item>
                            </div>

                            <ion-button
                                id="use-calculated-btn"
                                expand="block"
                                fill="outline"
                                class="mt-2"
                                onclick="useCalculatedTotal()">
                                {% trans "Use This Amount" %}
                            </ion-button>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- Hidden field for denominations JSON -->
                <input type="hidden" name="denominations_json" id="denominations-json" value="{}">

                <ion-item class="mt-3">
                    <ion-label position="stacked">{% trans "Closing Notes (Optional)" %}</ion-label>
                    <ion-textarea
                        name="notes"
                        rows="3"
                        placeholder="{% trans "Any discrepancies or notes..." %}">
                    </ion-textarea>
                </ion-item>

                <!-- Action Buttons -->
                <div class="mt-6 flex gap-3">
                    <ion-button
                        hx-get="{% url 'cash_register:dashboard' %}"
                        hx-target="#main-content-area"
                        hx-push-url="true"
                        fill="outline"
                        expand="block"
                        class="flex-1">
                        {% trans "Cancel" %}
                    </ion-button>
                    <ion-button
                        type="submit"
                        expand="block"
                        color="danger"
                        class="flex-1">
                        <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
                        {% trans "Close Session" %}
                    </ion-button>
                </div>
            </form>
        </ion-card-content>
    </ion-card>
    {% endfill %}
{% endcomponent %}

<script>
(function() {
    // Toggle denomination counter visibility
    window.toggleDenominationCounter = function() {
        var counter = document.getElementById('denomination-counter');
        var btn = document.getElementById('denomination-toggle');
        if (counter.style.display === 'none') {
            counter.style.display = 'block';
            btn.querySelector('span').textContent = '{% trans "Hide Calculator" %}';
        } else {
            counter.style.display = 'none';
            btn.querySelector('span').textContent = '{% trans "Count Denominations" %}';
        }
    };

    // Use calculated total from denominations
    window.useCalculatedTotal = function() {
        var totalEl = document.querySelector('#calculated-total ion-note');
        if (totalEl) {
            var text = totalEl.textContent.trim();
            // Extract numeric value (remove currency symbol)
            var match = text.match(/[\d.]+/);
            if (match) {
                var input = document.getElementById('closing-balance-input');
                if (input) {
                    input.value = match[0];
                    // Trigger HTMX update for difference calculation
                    htmx.trigger(input, 'input');
                }
            }
        }
    };

    // Collect denominations data before form submit
    document.addEventListener('htmx:configRequest', function(evt) {
        if (evt.detail.path.includes('close_session') || evt.detail.path.includes('api_close_session')) {
            var denominations = {};
            document.querySelectorAll('.denomination-input').forEach(function(input) {
                var count = parseInt(input.value) || 0;
                if (count > 0) {
                    var value = input.dataset.value;
                    denominations[value] = count;
                }
            });
            document.getElementById('denominations-json').value = JSON.stringify(denominations);
        }
    });
})();
</script>
