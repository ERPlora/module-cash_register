{% load static i18n ui component_tags %}

{# Toast listener for HX-Trigger events #}
<script>
(function() {
    if (!window._cashRegisterToastListenerAdded) {
        window._cashRegisterToastListenerAdded = true;
        document.body.addEventListener('showToast', function(e) {
            const detail = e.detail || {};
            const message = detail.message || 'Done';
            const color = detail.color || 'success';

            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.position = 'top';
            toast.color = color;
            document.body.appendChild(toast);
            toast.present();
        });
    }
})();
</script>

{% component "settings_page"
    title=_("Cash Register Settings")
    subtitle=_("Configure cash register module behavior")
    module_id="cash_register"
    tabbar_view="settings" %}

    {% fill "info" %}
        {# Read-only Hub global config #}
        <ion-card class="m-0 mb-lg">
            <ion-card-content>
                <div class="d-flex align-start gap-sm mb-md">
                    <ion-icon name="information-circle-outline" style="font-size: 20px; color: var(--color-primary);"></ion-icon>
                    <div>
                        <h4 class="fw-semibold mb-xs">{% trans "Hub Global Configuration" %}</h4>
                        <p class="fs-sm text-secondary m-0">{% trans "This configuration is managed in Hub Settings and applies to all modules" %}</p>
                    </div>
                </div>

                <div class="d-grid gap-sm" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                    <div class="p-sm rounded-lg" style="background: var(--bg-color-secondary);">
                        <div class="fs-xs text-secondary text-uppercase fw-semibold mb-xxs">{% trans "Currency" %}</div>
                        <div class="fs-lg fw-semibold">{{ HUB_CONFIG.currency }}</div>
                    </div>
                    <div class="p-sm rounded-lg" style="background: var(--bg-color-secondary);">
                        <div class="fs-xs text-secondary text-uppercase fw-semibold mb-xxs">{% trans "Business Name" %}</div>
                        <div class="fs-lg fw-semibold">{{ STORE_CONFIG.business_name|default:"-" }}</div>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    {% endfill %}

    {% fill "settings" %}
        {% csrf_token %}

        {% component "setting_section" title=_("Session Management") %}
            {% component "setting_toggle"
                name="enable_cash_register"
                title=_("Enable Cash Register")
                description=_("Enable/disable cash register functionality")
                checked=config.enable_cash_register
                hx_post="/m/cash_register/settings/toggle/" %}{% endcomponent %}

            {% component "setting_toggle"
                name="require_opening_balance"
                title=_("Require Opening Balance")
                description=_("Require cash count when opening a session")
                checked=config.require_opening_balance
                color="warning"
                hx_post="/m/cash_register/settings/toggle/" %}{% endcomponent %}

            {% component "setting_toggle"
                name="require_closing_balance"
                title=_("Require Closing Balance")
                description=_("Require cash count when closing a session")
                checked=config.require_closing_balance
                color="warning"
                hx_post="/m/cash_register/settings/toggle/" %}{% endcomponent %}

            {% component "setting_toggle"
                name="allow_negative_balance"
                title=_("Allow Negative Balance")
                description=_("Allow negative balance in cash register")
                checked=config.allow_negative_balance
                color="danger"
                hx_post="/m/cash_register/settings/toggle/" %}{% endcomponent %}
        {% endcomponent %}

        {% component "setting_section" title=_("POS Integration") %}
            {% component "setting_input"
                name="protected_pos_url"
                title=_("Protected POS URL")
                description=_("URL that requires an open cash session")
                value=config.protected_pos_url
                type="text"
                placeholder="/modules/sales/pos/" %}{% endcomponent %}
        {% endcomponent %}
    {% endfill %}

    {% fill "actions" %}
        <div class="setting-actions mt-lg pt-md">
            <ion-button
                color="medium"
                fill="outline"
                expand="block"
                hx-post="{% url 'cash_register:settings_reset' %}"
                hx-confirm="{% trans 'Reset all settings to defaults?' %}"
                hx-target="#main-content-area"
                hx-include="[name='csrfmiddlewaretoken']">
                <ion-icon slot="start" name="refresh-outline"></ion-icon>
                {% trans "Reset to Defaults" %}
            </ion-button>
        </div>
    {% endfill %}
{% endcomponent %}
